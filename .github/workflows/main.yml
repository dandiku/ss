name: fedora-rdp

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Setup Fedora Container
        run: |
          # Avvia container Fedora in background
          docker run -d --name fedora-rdp \
            -p 3389:3389 \
            fedora:latest sleep infinity
          
          # Installa pacchetti necessari
          docker exec fedora-rdp bash -c "
            dnf install -y xrdp tigervnc-server \
              xorg-x11-server-Xorg xorg-x11-xauth \
              @xfce-desktop-environment \
              passwd sudo procps-ng iproute iptables \
              wget curl tar gzip
          "

      - name: Configure xrdp and Create User
        run: |
          docker exec fedora-rdp bash -c '
            # Genera password casuale sicura
            PASSWORD=$(tr -dc "A-Za-z0-9!@#$%^&*" < /dev/urandom | head -c 16)
            
            # Crea utente RDP
            useradd -m -G wheel rdpuser
            echo "rdpuser:$PASSWORD" | chpasswd
            
            # Configura XFCE come desktop environment
            echo "export XDG_SESSION_TYPE=x11" > /home/rdpuser/.xsession
            echo "exec startxfce4" >> /home/rdpuser/.xsession
            chmod +x /home/rdpuser/.xsession
            
            # Configura xrdp
            sed -i "s/port=3389/port=3389/g" /etc/xrdp/xrdp.ini
            sed -i "s/security_layer=negotiate/security_layer=rdp/g" /etc/xrdp/xrdp.ini
            sed -i "s/crypt_level=high/crypt_level=low/g" /etc/xrdp/xrdp.ini
            
            # Genera certificati xrdp se non esistono
            if [ ! -f /etc/xrdp/key.pem ]; then
              cd /etc/xrdp
              openssl req -x509 -newkey rsa:2048 -nodes \
                -keyout key.pem -out cert.pem -days 365 \
                -subj "/C=US/ST=State/L=City/O=Org/CN=localhost"
              chown xrdp:xrdp key.pem cert.pem
              chmod 400 key.pem
            fi
            
            # Avvia xrdp manualmente
            /usr/sbin/xrdp-sesman
            /usr/sbin/xrdp
            
            # Salva le credenziali
            echo "RDP_PASSWORD=$PASSWORD" > /tmp/rdp_creds
          '
          
          # Recupera la password e salvala in GITHUB_ENV
          PASSWORD=$(docker exec fedora-rdp cat /tmp/rdp_creds | grep RDP_PASSWORD | cut -d'=' -f2)
          echo "RDP_CREDS=User: rdpuser | Password: $PASSWORD" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          docker exec fedora-rdp bash -c '
            # Scarica e installa Tailscale
            curl -fsSL https://tailscale.com/install.sh | sh
            
            # Avvia tailscaled in background
            /usr/sbin/tailscaled --state=/var/lib/tailscale/tailscaled.state &
            sleep 3
          '

      - name: Establish Tailscale Connection
        run: |
          docker exec fedora-rdp bash -c "
            # Connetti a Tailscale
            /usr/bin/tailscale up --authkey=${{ secrets.AAA_AUTH_KEY }} --hostname=gh-fedora-$GITHUB_RUN_ID --accept-routes
            
            # Attendi assegnazione IP
            for i in {1..20}; do
              TSIP=\$(/usr/bin/tailscale ip -4 2>/dev/null | head -n1)
              if [ -n \"\$TSIP\" ]; then
                echo \"TAILSCALE_IP=\$TSIP\" > /tmp/ts_ip
                echo \"Tailscale IP: \$TSIP\"
                break
              fi
              echo \"Waiting for Tailscale IP... attempt \$i\"
              sleep 3
            done
          "
          
          # Recupera l'IP Tailscale
          TSIP=$(docker exec fedora-rdp cat /tmp/ts_ip 2>/dev/null | grep TAILSCALE_IP | cut -d'=' -f2)
          if [ -z "$TSIP" ]; then
            echo "Failed to get Tailscale IP"
            exit 1
          fi
          echo "TAILSCALE_IP=$TSIP" >> $GITHUB_ENV
          echo "Tailscale connected: $TSIP"

      - name: Verify RDP Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          
          # Verifica che xrdp sia in ascolto
          docker exec fedora-rdp bash -c '
            if ! ss -tlnp 2>/dev/null | grep :3389; then
              echo "xrdp not listening on port 3389"
              # Prova a riavviare xrdp
              pkill -9 xrdp
              /usr/sbin/xrdp-sesman
              /usr/sbin/xrdp
              sleep 2
              if ! ss -tlnp 2>/dev/null | grep :3389; then
                echo "Failed to start xrdp"
                exit 1
              fi
            fi
            echo "âœ“ xrdp is running correctly on port 3389"
          '
          
          # Test connettivitÃ  dalla macchina host
          if ! nc -zv -w5 localhost 3389 2>&1 | grep -q succeeded; then
            echo "Warning: Could not verify RDP port from host"
          else
            echo "âœ“ RDP port accessible from host"
          fi

      - name: Display Connection Info
        run: |
          docker exec fedora-rdp bash -c '
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘         RDP CONNECTION INFO            â•‘"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘ Tailscale IP: '$TAILSCALE_IP'         "
            echo "â•‘ Username:     rdpuser                  â•‘"
            echo "â•‘ Password:     (see below)              â•‘"
            echo "â•‘ Port:         3389                     â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "ðŸ” Password: '$RDP_CREDS'"
            echo ""
            echo "ðŸ“ To connect:"
            echo "   remmina (Linux) or Microsoft Remote Desktop"
            echo "   Address: '$TAILSCALE_IP':3389"
            echo ""
          '

      - name: Maintain Connection
        run: |
          echo "[$(date)] RDP Session Active"
          echo "Press 'Cancel workflow' button to terminate"
          echo ""
          
          # Mantieni il workflow attivo
          while true; do
            # Verifica che xrdp sia ancora in esecuzione
            if ! docker exec fedora-rdp pgrep xrdp > /dev/null; then
              echo "[$(date)] xrdp stopped, restarting..."
              docker exec fedora-rdp /usr/sbin/xrdp-sesman
              docker exec fedora-rdp /usr/sbin/xrdp
            fi
            
            # Verifica che tailscale sia connesso
            STATUS=$(docker exec fedora-rdp /usr/bin/tailscale status --json 2>/dev/null | grep -o '"BackendState":"[^"]*"' | cut -d'"' -f4)
            if [ "$STATUS" != "Running" ]; then
              echo "[$(date)] Tailscale not running, status: $STATUS"
            fi
            
            echo "[$(date)] âœ“ Services running | IP: $TAILSCALE_IP"
            sleep 300
          done
